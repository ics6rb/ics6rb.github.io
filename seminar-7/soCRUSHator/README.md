# Сокращатор урлов

Это доработанный пример с семинаров, который представляет простейшую реализацию инструмента для сокращения URL - вы даете ссылку, вам генерится короткий slug, и в конечном итоге получается короткий URL, при переходе по которому вас редиректит на реальный.

Функционал приложения таков:

- можно добавлять ссылки, при этом проверяется, что URL - это URL, а также что slug уникален;
- по коротким ссылкам редиректит куда надо;
- можно посмотреть содержимое базы в XML;
- можно посмотреть содержимое базы с пагинацией (постраничным отображением).

Два последних пункта - чтобы было больше похоже на ЛР 11.

В проекте есть интернационализация - [I18n](https://guides.rubyonrails.org/i18n.html).

Также в проект воткнут Bootstrap4 и использованы различные хелперы для упрощения работы с ним.

Обо всем этом будет написано в этом README, но чтобы что-то понять, придется также полазить по коду.

## Bootstrap 4

Это самый быстрый пункт, который не имеет непосредственного отношения к ORM и нужен просто "для красоты".

Во-первых, **речь пойдет про Rails 6**. В 5 и ниже **ВСЕ ПО-ДУГОМУ**! Раньше рельса сама собирала JS и отдавала бандл. Теперь это делает Webpack - инструмент, написанный на JS, используемый в JS и по сути не имеющий отношения ни к Ruby, ни к рельсам. Если раньше Bootstrap ставился в рельсу, теперь он ставится в JS. Как этого добиться, можно посмотреть в [этом видео](https://youtu.be/BIxd501hP-g).

Во-вторых, отличие от видео в том, что CSS все еще собирается рельсой, именно поэтому в `app/assets/stylesheets` есть `application.css` с магическими комментариями. Если этот файл как-то изменить, перестанет работать автосборка `*.scss`-файлов из `app/assets/stylesheets`. Мы этого не хотим, поэтому импорт стилей бутстрапа сделали в файле `bootstrap-import.scss`, который подключится автоматически благодаря комментарию в `application.css`. Цвета и стили в Bootstrap, кстати, [можно кастомизировать](https://getbootstrap.com/docs/4.0/getting-started/theming/), **но только если SCSS, а не уже собранный архив с CSS**.

В-третьих, есть специальные гемы для того, чтобы с бутстрапом было работать легче - они умеют генерировать разметку за нас. Тут нам пригодились:

- формы - [`bootstrap_form`](https://github.com/bootstrap-ruby/bootstrap_form);
- пагинация - сам гем [`kaminari`](https://github.com/kaminari/kaminari), чтобы выглядел, как надо, [`bootstrap4-kaminari-views`](https://github.com/KamilDzierbicki/bootstrap4-kaminari-views).

## Гемы переводов

Переводы можно сделать используя [API Ruby on Rails](), однако ВНЕЗАПНО оказывается, что уже много переводов сделано за нас. Есть специальные гемы, которые могут вам пригодиться:

- `rails-i18n`;
- `kaminari-i18n`;

## Что смотреть

Тут только про Ruby без всяких ваших JS/Bootstrap.

1. Контроллер `LinkController` - там все точки входа.
2. Контроллер `LinkController` - там непонятно откуда взявшийся `not_found`, а также наводочка на то, как заставить локаль работать между запросами.
3. Модель `Link` - там бизнес-логика работы со ссылками.
4. Валидатор `CorrectUriValidator` - чисто авторская методика, по умолчанию места для валидаторов нет.
5. ~~Вьюхи~~ представления контроллера `link` - там можно посмотреть, как же пагинировать, отсовывать ошибки и пользоваться бутстраповскими хелперами форм.
6. `config/initializers/locale.rb` - здесь ставим локаль по умолчанию.
7. `config/locales` - тут переводы.
8. `config/routes.rb` - тут маршруты - все хитро и сложно, как обещал.
9. `db/migrate` - целых ДВЕ миграции: одна на создание таблицы, еще одна на добавление уникального индекса.
10. `spec` - используем RSpec, чтобы было стильно и модно. Тут много! (: **Запуск тестов - `rspec`**.

## Как запустить

```shell
bundle
yarn install
rails db:migrate
rails s
```

## Как повторить

Создать приложение без тестов

```shell
rails new soCRUSHator -T
```

Добавить в Gemfile `gem 'rspec-rails', '~> 4.0.1'` и все инициализировать `rails g rspec:install`.

Теперь нужен контроллер

```shell
rails g controller link index add redirect
```

Модель

```shell
rails g model link url:string slug:string clicks:integer
rails db:migrate # Чтобы накатить, сразу необязательно, но забывать также не нужно.
```

Уникальный индекс к существующей колонке

```shell
rails g migration add_index_to_links slug:uniq
```

**Вниманиие!** Миграция будет пытаться делать `add_column :slug`, но такая колонка у нас уже есть. **Строку с добавлением нужно стереть**.
